<div class="teams-container">
  <div class="teams-header">
    <div class="header-content">
      <h1>Teams</h1>
      <p>Manage and view all company teams</p>
    </div>
    <div class="header-actions" *ngIf="canCreateTeam()">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span class="material-icons">add</span>
        Create Team
      </button>
    </div>
  </div>

  <div class="team-stats" *ngIf="teams().length > 0">
    <div class="stat-card">
      <div class="stat-number">{{ teams().length }}</div>
      <div class="stat-label">Total Teams</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ getTotalMembers() }}</div>
      <div class="stat-label">Total Members</div>
    </div>
    <!-- <div class="stat-card">
      <div class="stat-number">{{ getAverageTeamSize() }}</div>
      <div class="stat-label">Avg Team Size</div>
    </div> -->
  </div>

  <div class="teams-content">
    <div class="teams-grid" *ngIf="teams().length > 0">
      <div class="team-card" *ngFor="let team of teams()">
        <div class="team-header">
          <div class="team-info">
            <h3 class="team-name">{{ team.teamName }}</h3>
            <p class="team-description" *ngIf="team.description">{{ team.description }}</p>
          </div>
          <div class="team-actions" *ngIf="canManageTeam()">
            <button class="action-btn edit-btn" (click)="editTeam(team)" title="Edit Team">
              <span class="material-icons">edit</span>
            </button>
            <button class="action-btn delete-btn" (click)="deleteTeam(team)" title="Delete Team">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>

        <div class="team-members">
          <div class="members-header">
            <span class="members-count">{{ team.members.length }} Members</span>
            <button 
              class="btn btn-sm btn-outline" 
              *ngIf="canManageTeam()"
              (click)="openMembersModal(team)"
            >
              Manage Members
            </button>
          </div>
          <div class="members-list">
            <div class="member-avatar" 
                 *ngFor="let member of team.members.slice(0, 5)" 
                 [class]="getRoleClass(member.roleInTeam)"
                 [title]="getUserName(member.userId) + ' (' + member.roleInTeam + ')'">
              {{ getUserInitials(member.userId) }}
              <div class="member-role-indicator" *ngIf="member.roleInTeam !== 'Member'">
                {{ getRoleIcon(member.roleInTeam) }}
              </div>
            </div>
            <div class="more-members" *ngIf="team.members.length > 5">
              +{{ team.members.length - 5 }}
            </div>
          </div>
        </div>

        <div class="team-meta">
          <span class="created-date">Created {{ team.createdAt | date:'MMM dd, yyyy' }}</span>
        </div>
      </div>
    </div>

    <div class="empty-state" *ngIf="teams().length === 0">
      <div class="empty-icon">ðŸ‘¥</div>
      <h3>No Teams</h3>
      <p>There are no teams created yet.</p>
      <button class="btn btn-primary" *ngIf="canCreateTeam()" (click)="openCreateModal()">
        Create First Team
      </button>
    </div>
  </div>

  <!-- Create/Edit Team Modal -->
  <div class="modal-overlay" *ngIf="showModal()" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingTeam ? 'Edit Team' : 'Create New Team' }}</h2>
        <button class="close-btn" (click)="closeModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <form [formGroup]="teamForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="teamName" class="form-label">Team Name *</label>
          <input
            type="text"
            id="teamName"
            formControlName="teamName"
            class="form-control"
            [class.is-invalid]="submitted && f['teamName'].errors"
            placeholder="Enter team name"
          />
          <div class="invalid-feedback" *ngIf="submitted && f['teamName'].errors">
            <div *ngIf="f.teamName.errors['required']">Team name is required</div>
          </div>
        </div>

        <div class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea
            id="description"
            formControlName="description"
            class="form-control"
            rows="3"
            placeholder="Enter team description (optional)"
          ></textarea>
        </div>

        <!-- Member Selection for New Teams -->
        <div class="form-group" *ngIf="!editingTeam">
          <label class="form-label">Add Members (Optional)</label>
          
          <!-- Member Search -->
          <div class="member-search">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (input)="onSearchUsers()"
              placeholder="Search users to add..."
              class="search-input"
              [ngModelOptions]="{standalone: true}"
            />
            
            <!-- Search Results -->
            <div class="search-results" *ngIf="searchTerm && filteredUsers().length > 0">
              <div 
                class="search-result-item" 
                *ngFor="let user of filteredUsers().slice(0, 5)"
                (click)="selectUser(user)"
              >
                <div class="search-result-avatar">
                  {{ getInitials(user.firstName, user.lastName) }}
                </div>
                <div class="search-result-info">
                  <div class="search-result-name">{{ user.firstName }} {{ user.lastName }}</div>
                  <div class="search-result-email">{{ user.primaryEmail }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Selected Members Tags -->
          <div class="selected-members" *ngIf="selectedMembers.length > 0">
            <h4>Selected Members ({{ selectedMembers.length }})</h4>
            <div class="member-tags">
              <div class="member-tag" *ngFor="let member of selectedMembers">
                <div class="member-tag-avatar">
                  {{ getInitials(member.user.firstName, member.user.lastName) }}
                </div>
                <div class="member-tag-info">
                  <div class="member-tag-name">{{ member.user.firstName }} {{ member.user.lastName }}</div>
                  <div class="member-tag-role">{{ member.roleInTeam }}</div>
                </div>
                <select 
                  class="role-select"
                  [value]="member.roleInTeam"
                  (change)="updateMemberRole(member.user.userId, $event.target.value)"
                >
                  <option value="Member">Member</option>
                  <option value="Lead">Lead</option>
                  <option value="Manager">Manager</option>
                </select>
                <button 
                  type="button"
                  class="remove-member"
                  (click)="removeMember(member.user.userId)"
                >
                  <span class="material-icons">close</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" (click)="closeModal()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            {{ loading ? 'Creating...' : (editingTeam ? 'Update Team' : 'Create Team') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Members Modal -->
  <div class="modal-overlay" *ngIf="showMembersModal()" (click)="closeMembersModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Manage Team Members - {{ selectedTeam?.teamName }}</h2>
        <button class="close-btn" (click)="closeMembersModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="members-management">
        <!-- Current Members -->
        <div class="current-members" *ngIf="selectedTeam">
          <h3>Current Members ({{ selectedTeam.members.length }})</h3>
          <div class="member-list">
            <div class="member-item" *ngFor="let member of selectedTeam.members">
              <div class="member-info">
                <div class="member-avatar-small">{{ getUserInitials(member.userId) }}</div>
                <span class="member-name">{{ getUserName(member.userId) }}</span>
                <span class="member-role">({{ member.roleInTeam }})</span>
              </div>
              <button 
                class="btn btn-sm btn-error" 
                (click)="deleteMember(member.teamMemberId)"
                *ngIf="canManageTeam()"
              >
                Remove
              </button>
            </div>
          </div>
        </div>

        <!-- Add New Members -->
        <div class="add-members">
          <h3>Add New Members</h3>
          
          <!-- Member Search -->
          <div class="member-search">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (input)="onSearchUsers()"
              placeholder="Search users to add..."
              class="search-input"
            />
            
            <!-- Search Results -->
            <div class="search-results" *ngIf="searchTerm && filteredUsers().length > 0">
              <div 
                class="search-result-item" 
                *ngFor="let user of filteredUsers().slice(0, 5)"
                (click)="selectUser(user)"
              >
                <div class="search-result-avatar">
                  {{ getInitials(user.firstName, user.lastName) }}
                </div>
                <div class="search-result-info">
                  <div class="search-result-name">{{ user.firstName }} {{ user.lastName }}</div>
                  <div class="search-result-email">{{ user.primaryEmail }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Selected Members to Add -->
          <div class="selected-members" *ngIf="selectedMembers.length > 0">
            <h4>Members to Add ({{ selectedMembers.length }})</h4>
            <div class="member-tags">
              <div class="member-tag" *ngFor="let member of selectedMembers">
                <div class="member-tag-avatar">
                  {{ getInitials(member.user.firstName, member.user.lastName) }}
                </div>
                <div class="member-tag-info">
                  <div class="member-tag-name">{{ member.user.firstName }} {{ member.user.lastName }}</div>
                  <div class="member-tag-role">{{ member.roleInTeam }}</div>
                </div>
                <select 
                  class="role-select"
                  [value]="member.roleInTeam"
                  (change)="updateMemberRole(member.user.userId, $event.target.value)"
                >
                  <option value="Member">Member</option>
                  <option value="Lead">Lead</option>
                  <option value="Manager">Manager</option>
                </select>
                <button 
                  type="button"
                  class="remove-member"
                  (click)="removeMember(member.user.userId)"
                >
                  <span class="material-icons">close</span>
                </button>
              </div>
            </div>
            
            <div class="modal-actions">
              <button type="button" class="btn btn-outline" (click)="closeMembersModal()">
                Cancel
              </button>
              <button 
                type="button" 
                class="btn btn-primary" 
                [disabled]="loading"
                (click)="addSelectedMembers()"
              >
                {{ loading ? 'Adding...' : 'Add Members' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>